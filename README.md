# My_Home

[![hacs badge](https://img.shields.io/badge/HACS-Default-orange.svg)](https://github.com/custom-components/hacs)
[![HACS Supported](https://img.shields.io/badge/HACS-Supported-green.svg)](https://hacs.xyz)
[![hacs_badge](https://img.shields.io/badge/HACS-Custom-orange.svg)](https://github.com/custom-components/hacs)

Состояние моей системы в работе


- **Тест Сервер:**

  - Pentium(R) Dual-Core CPU E5300 @ 2.60GHz, 2 ядра
  - 2*2gb DDR2 RAM
  - 500Gb Seagate

- **UPS:**
  - Ippon Back comfo Rro 600

- **Программное обеспечение:** 

  - [Ubuntu Linux 20.04.2 LTS](https://releases.ubuntu.com/20.04/)
  - [Home Assistant core](https://www.home-assistant.io/installation/linux#install-home-assistant-core)
  - [HACS](https://hacs.xyz/)

## Devices
- **Hub:**
  - Mi Smart Home Hub (ZNDMWG02LM, Zigbee 3.0/Bluetooth (BLE Mesh) 5.0/Wi-Fi 2.4GHz)

- **Zigbee:**
  - Sonoff Temperature and Humidity Sensor (SNZB-02, CR2450)
  - Sonoff Wireless Door and Window Sensor (SNZB-04, CR2032)
  - Sonoff ZB MINI
  - Aqara Vibration Sensor (DJT11LM, CR2032)
  - Aqara Temperature and Humidity Sensor (WSDCGQ11LM, CR2032)
  - Xiaomi Mijia Smart Light Sensor (GZCGQ01LM, CR2450)

- **Bluetooth:**
  - Xiaomi Door Sensor2 (MCCGQ02HL, 5.1 BLE, CR2032)
  - Xiaomi Mijia Human body Sensor 2 (RTCQ02LM, 5.1 BLE, CR2450)

- **WiFi:**
  - Sonoff MINI 2 DIY WiFi

## Интеграции:
<details><summary>Home Assistant:</summary>
<p>

  * [Zigbee Home Automation](https://www.home-assistant.io/integrations/zha/)
  * [AirVisual Cloud API](https://www.home-assistant.io/integrations/airvisual)
  * [Google Cast](https://www.home-assistant.io/integrations/cast)
  * [Meteorologisk institutt (Met.no)](https://www.home-assistant.io/integrations/met)
  * [MQTT](https://www.home-assistant.io/integrations/mqtt)
  * [Network UPS Tools (NUT)](https://www.home-assistant.io/integrations/nut)
  * [OpenWeatherMap](https://www.home-assistant.io/integrations/openweathermap)
  * [Plex Media Server](https://www.home-assistant.io/integrations/plex)
  * [Samsung Smart TV](https://www.home-assistant.io/integrations/samsungtv)
  * [Speedtest.net](https://www.home-assistant.io/integrations/speedtestdotnet)
  * [UPnP/IGD](https://www.home-assistant.io/integrations/upnp)
  * [Tuya](https://www.home-assistant.io/integrations/tuya)
  
  
  * [Local IP Address](https://www.home-assistant.io/integrations/local_ip)
  * [Mobile App](https://www.home-assistant.io/integrations/mobile_app)
  * [Shopping List](https://www.home-assistant.io/integrations/shopping_list)
  * [Certificate Expiry](https://www.home-assistant.io/integrations/cert_expiry)
  
  

</p>
</details>
  

<details><summary>HACS:</summary>
<p>


  * [Xiaomi Gateway 3](https://github.com/AlexxIT/XiaomiGateway3)
  * [SonoffLAN](https://github.com/AlexxIT/SonoffLAN)
  * [YandexStation](https://github.com/AlexxIT/YandexStation)
  
  * [StartTime](https://github.com/AlexxIT/StartTime)
  * [MorphNumbers](https://github.com/AlexxIT/MorphNumbers)
  * [PythonScriptsPro](https://github.com/AlexxIT/PythonScriptsPro)
  
  * [Alarmo](https://github.com/nielsfaber/alarmo)

  * [scheduler-component](https://github.com/nielsfaber/scheduler-component)





  * [hass-lkcomu-interrao (ЕЛК ЖКХ «Интер РАО»)](https://github.com/alryaz/hass-lkcomu-interrao)

  * [Scheduler-component](https://github.com/nielsfaber/scheduler-component)
  * [Sensor.yandex_maps](https://github.com/custom-components/sensor.yandex_maps)
  * [irrigation_unlimited](https://github.com/rgc99/irrigation_unlimited)
  * [yandex_smart_home](https://github.com/dmitry-k/yandex_smart_home)



  * [weather-card](https://github.com/bramkragten/weather-card)
  * [flex-table-card](https://github.com/custom-cards/flex-table-card)
  * [mini-graph-card](https://github.com/kalkih/mini-graph-card)
  * [lovelace-auto-entities](https://github.com/thomasloven/lovelace-auto-entities)
  * [mini-media-player](https://github.com/kalkih/mini-media-player)
  * [scheduler-card](https://github.com/nielsfaber/scheduler-card)
  * [stack-in-card](https://github.com/custom-cards/stack-in-card)
  * [battery-state-card](https://github.com/maxwroc/battery-state-card)
  * [hass-bha-icons](https://github.com/hulkhaugen/hass-bha-icons)
  * [ha-lovelace-elapsed-time-card](https://github.com/kirbo/ha-lovelace-elapsed-time-card)
  * [lovelace-tempometer-gauge-card](https://github.com/SNoof85/lovelace-tempometer-gauge-card)
  * [air-visual-card](https://github.com/dnguyen800/air-visual-card)
  * [ha-yandex-icons](https://github.com/iswitch/ha-yandex-icons)
  * [simple-thermostat](https://github.com/nervetattoo/simple-thermostat)
  * [vertical-stack-in-card](https://github.com/ofekashery/vertical-stack-in-card)
  * [mini-humidifier](https://github.com/artem-sedykh/mini-humidifier)
  * [lovelace-multiple-entity-row](https://github.com/benct/lovelace-multiple-entity-row)
  * [logbook-card](https://github.com/royto/logbook-card)

  * [home-assistant-sun-card](https://github.com/AitorDB/home-assistant-sun-card)
  * [zha-network-card](https://github.com/dmulcahey/zha-network-card)
  * [apexcharts-card](https://github.com/RomRider/apexcharts-card#yaxis-options-multi-y-axis)
  * [lovelace-fold-entity-row](https://github.com/thomasloven/lovelace-fold-entity-row)
  * [lovelace-layout-card](https://github.com/thomasloven/lovelace-layout-card)

  * [hass-yandex-music-browser](https://github.com/alryaz/hass-yandex-music-browser)
  * [hass-moscow-pgu](https://github.com/alryaz/hass-moscow-pgu)
  * [SamsungTV Tizen](https://github.com/jaruba/ha-samsungtv-tizen)
  * [button-card](https://github.com/custom-cards/button-card)
  * [timer-bar-card](https://github.com/rianadon/timer-bar-card)
  * [hass-node-red](https://github.com/zachowj/hass-node-red)
  * [lovelace-card-mod](https://github.com/thomasloven/lovelace-card-mod)
  * [ha-gismeteo](https://github.com/Limych/ha-gismeteo)
  * [simple-weather-card](https://github.com/kalkih/simple-weather-card)
  * [slider-button-card](https://github.com/mattieha/slider-button-card)
  * [lovelace-card-mod](https://github.com/thomasloven/lovelace-card-mod)
  * [home-assistant-variables](https://github.com/snarky-snark/home-assistant-variables)
  * [bar-card](https://github.com/custom-cards/bar-card)
  
  
</p>
</details>
  

  
  
  
<details><summary>HACS темы:</summary>
<p>
  
</p>
</details>

## Установка:
<details><summary>Ubuntu Linux 20.04.2 LTS:</summary>
<p>



  
  
 </p>
</details> 




<details><summary>Home Assistant:</summary>
<p>

1. Обновляем систему "Ubuntu Server" до актуального состояния
```shell
sudo apt-get update
```
```shell
sudo apt-get upgrade -y
```
2. После обновления системы устанавливаем необходимые компоненты и зависимости. 
```shell
sudo apt-get install python3 python3-dev python3-venv python3-pip libffi-dev libssl-dev autoconf build-essential
```
2.1 Соглошаемся
```shell
Y
``` 
  
3. Создаем нового системного пользователя с домашней папкой для запуска и работы ядра Home Assistant, назовем его homeassistant. Добавим его в группу dialout для взаимодействия с устройствами Z-Wave и ZigBee
```shell
sudo useradd -rm homeassistant -G dialout
```   
  
4.  Далее создаем папку для ядра Home Assistant и устанавливаем пользователя homeassistant для неё владельцем 
```shell
cd /srv
```   
```shell
sudo mkdir homeassistant
```  
```shell
sudo chown homeassistant:homeassistant /srv/homeassistant
```   
  
5. Теперь создаем виртуальное окружение для ядра Home Assistant, делаем это для учетной записи homeassistant 
```shell
sudo -u homeassistant -H -s 
```   
```shell
cd /srv/homeassistant
```  
```shell
python3 -m venv .
```  
```shell
source bin/activate
```   
  
6.  После активации виртуальной среды выполняем установку необходимого пакета Python
```shell
python3 -m pip install wheel
```   
  
7. По завершении установки пакета Python приступаем к установке Home Assistant
```shell
pip3 install homeassistant
```   
8. Запускаем наш Home Assistant в первый раз. При первом запуске в домашнем каталоге пользователя homeassistant (/home/homeassistant) будет создана папка .homeassistant, в которой будут находится конфигурационные файлы системы
 ```shell
hass
```   

9. Первый запуск может занимать 5-10 МИНУТ, после чего проверяем доступность установленной системы через браузер http://192.168.Х.ХХ:8123 

10. Прерываем работу запущенной системы
```shell
Ctrl+C
```   

10.1 Выходим из учетной записи пользователя homeassistant   
```shell
exit
```    
  
11. Создаем файл для запуска сервиса при старте системы
```shell
sudo nano /etc/systemd/system/homeassistant@homeassistant.service
```   
  
11.1 Заполняем его
```yaml
[Unit]
Description=Home Assistant
After=network-online.target
[Service]
Type=simple
User=%i
WorkingDirectory=/home/%i/.homeassistant
ExecStart=/srv/homeassistant/bin/hass -c "/home/%i/.homeassistant"

[Install]
WantedBy=multi-user.target
``` 
  
11.2 Выходим
```shell
Ctrl+X
Y
Enter
```    
  
12. Запускаем сервис
```shell
sudo systemctl --system daemon-reload
``` 
```shell
sudo systemctl enable homeassistant@homeassistant.service
``` 
```shell
sudo systemctl start homeassistant@homeassistant.service
``` 
  
13. Проверяем работу сервиса
```shell
sudo systemctl status homeassistant@homeassistant.service
``` 
  
13.1 Проверяем доступность установленной системы через браузер http://192.168.Х.ХХ:8123

13.2 Выходим
```shell
Ctrl+X
```     
  
14. Перезагружаем систему
```shell
su reboot
```  

</p>
</details> 
  
<details><summary>Обновление Home Assistant:</summary>
<p>
  
1. Вводим
```shell
sudo -u homeassistant -H -s
``` 
```shell
source /srv/homeassistant/bin/activate
``` 
```shell
pip3 install --upgrade homeassistant
```   
```shell
exit
```   

2. После обновления выполняем перезапуск службы
```shell
sudo systemctl restart homeassistant@homeassistant.service
```
2.1 Проверяем доступность установленной системы через браузер http://192.168.Х.ХХ:8123
    
3. Перезагружаем систему
```shell
su reboot
```
</p>
</details>
 


<details><summary>HACS:</summary>
<p>

1. Сначала нам надо создать новую папку для кастомных компонентов
```shell
cd /home/homeassistant/.homeassistant/
```
```shell
sudo mkdir custom_components
```
```shell
sudo chmod 777 custom_components/
```

2. Устанавливаем unzip, потому что его нет в штатной поставке Ubuntu
```shell
sudo apt install unzip
```

3. Запускаем скрипт установки
```shell
wget -q -O - https://install.hacs.xyz | bash -
```

3. 1 Установка должна завершиться надписью "Installation completed".
```shell
INFO: Creating HACS directory...
INFO: Unpacking HACS...
INFO: Removing HACS zip file...
INFO: Installation complete.
```
  
4. Перезагружаем систему
```shell
su reboot
```
  
</p>
</details>   
  


<details><summary>Получаем сертификат HTTPS:</summary>
<p>

1. Теперь нам необходимо поставить пакет для запроса и получения ssl сертификата
```shell
sudo apt-get install certbot
```

2. Получаем сертификат ХХХХХХХХХ-водим свои данные
```shell
sudo certbot certonly --standalone --email ХХХХХХХХХ@gmail.com  -d ХХХХХХХХХ.asuscomm.com
```

2.1 Если все сделано правильно, вывод команды будет примерно такой
```shell
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator standalone, Installer None
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for your.domain.org
Waiting for verification...
Cleaning up challenges

IMPORTANT NOTES:
 - Congratulations<span class="cm-variable-2"></span><span class="cm-variable-2"></span><span class="cm-variable-2"></span><span class="cm-variable-2"></span>! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/your.domain.org/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/your.domain.org/privkey.pem
   Your cert will expire on 2019-02-19. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   "certbot renew"
 - If<span class="cm-variable-2"></span><span class="cm-variable-2"></span><span class="cm-variable-2"></span><span class="cm-variable-2"></span> you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
```

3. Теперь нам необходимо копировать полученные сертификаты в папку настроек HA. Делаем следующее
```shell
cd /home/homeassistant/.homeassistant/
```
```shell
sudo cp /etc/letsencrypt/live/ХХХХХХХХХ.asuscomm.com/fullchain.pem fullchain.pem
```
```shell
sudo cp /etc/letsencrypt/live/ХХХХХХХХХ.asuscomm.com/privkey.pem privkey.pem
```
```shell
sudo chown -R homeassistant:homeassistant /home/homeassistant/.homeassistant/
```

4. После открываем файл configuration.yaml вашего HA удобным для вас способом и в разделе http: прописываем следующее
```yaml
http:
  ssl_certificate: /home/homeassistant/.homeassistant/fullchain.pem
  ssl_key: /home/homeassistant/.homeassistant/privkey.pem
```

Теперь наконец можем перезагрузить нашу систему

 ```shell
su reboot
```
  
и попробовать перейти на его вебморду, используя свеженастроеный https используя адрес вида https://ХХХХХХХХХ.asuscomm.com проверив тем самым, что все настроено правильно. 

P.S. Не забывайте, что сертификаты выдаются сроком на три месяца, и спустя этот срок, необходимо будет повторить действия из раздела "Получаем сертификат" п.2.

</p>
</details> 














